@base <http://example.org/pipeline/> .
@prefix code: <https://code.described.at/> .
@prefix p: <https://pipeline.described.at/> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .

<variables> p:variable
  [
    a p:Variable;
    p:name "url" ;
    p:value "http://worldclockapi.com/api/json/cet/now"
  ], [
    a p:Variable;
    p:name "context" ;
    p:value """{"date\":"http://purl.org/dc/elements/1.1/date"}"""
  ] .

<> a p:Pipeline ;
  p:variables <variables> ;
  p:steps [
    p:stepList ( <fetch> <jsonldStructure> <serialize> )
  ] .

<fetch> a p:Step ;
  code:implementedBy [
    code:link <file:./node_modules/barnard59-base#fetch.json> ;
    a code:EcmaScript
  ];
  code:arguments ("${url}"^^code:EcmaScriptTemplateLiteral) .

<jsonldStructure> a p:Step ;
  code:implementedBy [
    code:link <node:barnard59-base#map> ;
    a code:EcmaScript
  ];
  code:arguments ("json => { return { '@context': JSON.parse(this.variables.get('context')), '@id': this.variables.get('url'), date: json.currentDateTime } }"^^code:EcmaScript) .

<serialize> a p:Step ;
  code:implementedBy [
    code:link <file:node_modules/barnard59-base#json.stringify> ;
    a code:EcmaScript
  ] .
